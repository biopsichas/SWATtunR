<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SWATtunR">
<title>Crop Yields • SWATtunR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Crop Yields">
<meta property="og:description" content="SWATtunR">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SWATtunR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Introduction</h6>
    <a class="dropdown-item" href="../articles/intro.html">Overview</a>
    <a class="dropdown-item" href="../articles/init.html">Getting Started</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Soft calibration</h6>
    <a class="dropdown-item" href="../articles/sc-crops.html">Crop Yields</a>
    <a class="dropdown-item" href="../articles/sc-wy.html">Water Yield</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/biopsichas/SWATtunR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Crop Yields</h1>
            <h3 data-toc-skip class="subtitle">Soft calibration workflow
for crop yields in SWAT+ models</h3>
            
      
      <small class="dont-index">Source: <a href="https://github.com/biopsichas/SWATtunR/blob/HEAD/vignettes/sc-crops.Rmd" class="external-link"><code>vignettes/sc-crops.Rmd</code></a></small>
      <div class="d-none name"><code>sc-crops.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <strong>SWATtunR</strong> package provides a structured approach
to soft calibration of crop parameters, aiming to align SWAT+
simulations with observed crop yields. This process is detailed in a
template script, initially developed under the EU project <a href="https://www.optain.eu/" class="external-link">OPTAIN</a> and documented in its <a href="https://zenodo.org/records/11233622" class="external-link">deliverables</a>, where its
application across various European case studies is explored. The
calibration is a two-stage routine designed to be tailored to individual
SWAT projects. First, it adjusts the days to maturity for each crop to
match its characteristics and management schedules. Subsequently,
additional crop parameters can be fine-tuned if necessary to achieve
accurate yield simulations, ensuring a robust and reproducible
calibration process.</p>
</div>
<div class="section level2">
<h2 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h2>
<p>In your created soft calibration directory with the
<code><a href="../reference/initialize_softcal.html">initialize_softcal()</a></code> function, the
<code>workflow/01_crops_calibration.R</code> script file is included.
This script serves as a starting point, providing a customizable
template to guide users through the crop soft calibration process
effectively.</p>
<p>Following the steps outlined in this page comes from the script,
users can adapt the calibration routine to their specific SWAT+ model
setup and observed data. The script is designed to be flexible, allowing
for modifications based on the unique characteristics of the crops being
modeled and the management practices in place.</p>
<p><img src="figs/fig4.png" width="95%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="scc_step1">1. Load packages, settings and yield data<a class="anchor" aria-label="anchor" href="#scc_step1"></a>
</h2>
<p>The <strong>SWATtunR</strong> package is essential for soft
calibration, as it provides the necessary functions for the calibration
process. Additional packages are required for data manipulation,
visualization, SWAT+ model runs, etc. Example here is provided using
SWAT+ model setup provided by <strong>SWATdata</strong> package, but the
workflow can be applied to any SWAT+ project.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Required libraries to run workflow</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/biopsichas/SWATtunR" class="external-link">SWATtunR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chrisschuerz/SWATrunR" class="external-link">SWATrunR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Parameter definition ----------------------------------------------------</span></span>
<span><span class="co"># Path to the SWAT+ project folder.</span></span>
<span><span class="va">model_path</span> <span class="op">&lt;-</span> <span class="st">'test/swatplus_rev60_demo'</span></span>
<span></span>
<span><span class="co"># Set the number of cores for parallel model execution</span></span>
<span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="cn">Inf</span> <span class="co"># Inf uses all cores. Set lower value if preferred.</span></span>
<span></span>
<span><span class="co"># Set the number parameter combinations for the LHS sampling of crop parameters</span></span>
<span><span class="va">n_combinations</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co"># Path to the observed crop yields.</span></span>
<span><span class="co"># This file must be updated with case study specific records!</span></span>
<span><span class="va">yield_obs_path</span> <span class="op">&lt;-</span> <span class="st">'./observation/crop3.csv'</span></span>
<span></span>
<span><span class="co"># Load and prepare data ---------------------------------------------------</span></span>
<span><span class="co"># Load the yield observations</span></span>
<span><span class="va">yield_obs</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">yield_obs_path</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the crops which should be used in the calibration.</span></span>
<span><span class="co"># Default is all crops which are defined in yield_obs.</span></span>
<span><span class="co"># Please define manually if only selected crops should be considered.</span></span>
<span><span class="va">crop_names</span> <span class="op">&lt;-</span> <span class="va">yield_obs</span><span class="op">$</span><span class="va">plant_name</span></span>
<span></span>
<span><span class="co"># Optional reset of plants.plt --------------------------------------------</span></span>
<span><span class="co"># In the case the crop calibration workflow should be redone after the last step</span></span>
<span><span class="co"># of this script was already executed and the plants.plt was overwritten the</span></span>
<span><span class="co"># plants.plt should be reset to its initial condition. To perform the reset set</span></span>
<span><span class="co"># reset &lt;- TRUE</span></span>
<span><span class="va">reset</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="va">reset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.copy</a></span><span class="op">(</span><span class="st">'./backup/plants.plt'</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">model_path</span>, <span class="st">'/plants.plt'</span><span class="op">)</span>,</span>
<span>            overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="st">'./backup/plants.plt'</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">model_path</span>, <span class="st">'/plants.plt'</span><span class="op">)</span>,</span>
<span>            <span class="st">'./backup/plants.plt'</span>,</span>
<span>            overwrite <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In your case the crop yield information is quite simple.</p>
<p><img src="figs/fig5.png" width="60%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="scc_step2">2. Generate days_mat parameter set<a class="anchor" aria-label="anchor" href="#scc_step2"></a>
</h2>
<p>The days to maturity (<code>days_mat</code>) determine how quickly or
slowly a crop develops in a SWAT+ model, as it is converted into the
heat units required for a crop to fully mature. To ensure the crop
behaves as intended, the days_mat value must align with the defined
management operations schedule. To identify suitable days_mat values for
selected crops, a parameter set is created where the
<code>days_mat</code> value with <code>sample_day_mat()</code> function
for each crop is varied within a range (change_min, change_max) using
fixed intervals (change_step).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_dmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_days_mat.html">sample_days_mat</a></span><span class="op">(</span><span class="va">crop_names</span><span class="op">)</span></span></code></pre></div>
<p><code>par_dmat</code> is a data frame containing the
<code>days_mat</code> values for each crop, which will be used in the
calibration process. <code>plants.plt</code> file is used to get initial
values The function <code><a href="../reference/sample_days_mat.html">sample_days_mat()</a></code> generates a range of
values based on the defined parameters.</p>
<p><img src="figs/fig6.png" width="90%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="run-model-for-parameter-set">3. Run model for parameter set<a class="anchor" aria-label="anchor" href="#run-model-for-parameter-set"></a>
</h2>
<p>The next step is to run the SWAT+ model with the generated
<code>days_mat</code> parameter set. The <code>run_swatplus</code>
function from <strong>SWATrunR</strong> package executes the model
simulations for each combination of parameters in <code>par_dmat</code>.
The results are stored in <code>simulation</code> folder, which can be
used for further analysis. The folder will include a timestamp to
distinguish each run. When the process is repeated, the analysis will
automatically use the most recent set of simulation results.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the SWAT+ model with the generated days_mat parameter set</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/run_swatplus.html" class="external-link">run_swatplus</a></span><span class="op">(</span>project_path <span class="op">=</span> <span class="va">model_path</span>,</span>
<span>             output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>yld <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/define_output.html" class="external-link">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'mgtout'</span>,</span>
<span>                                               variable <span class="op">=</span> <span class="st">'yld'</span>,</span>
<span>                                               label <span class="op">=</span> <span class="va">crop_names</span><span class="op">)</span>,</span>
<span>                           bms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/define_output.html" class="external-link">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'mgtout'</span>,</span>
<span>                                               variable <span class="op">=</span> <span class="st">'bioms'</span>,</span>
<span>                                               label <span class="op">=</span> <span class="va">crop_names</span><span class="op">)</span>,</span>
<span>                           phu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/define_output.html" class="external-link">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'mgtout'</span>,</span>
<span>                                               variable <span class="op">=</span> <span class="st">'phu'</span>,</span>
<span>                                               label <span class="op">=</span> <span class="va">crop_names</span><span class="op">)</span></span>
<span>             <span class="op">)</span>,</span>
<span>             parameter        <span class="op">=</span> <span class="va">par_dmat</span>,</span>
<span>             start_date       <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Change if necessary.</span></span>
<span>             end_date         <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Change if necessary.</span></span>
<span>             years_skip       <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Change if necessary.</span></span>
<span>             n_thread         <span class="op">=</span> <span class="va">n_cores</span>,</span>
<span>             save_path        <span class="op">=</span> <span class="st">'./simulation'</span>,</span>
<span>             save_file        <span class="op">=</span> <span class="fu"><a href="../reference/add_timestamp.html">add_timestamp</a></span><span class="op">(</span><span class="st">'sim_dmat'</span><span class="op">)</span>,</span>
<span>             return_output    <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>             time_out         <span class="op">=</span> <span class="fl">3600</span> <span class="co"># seconds, change if run-time differs</span></span>
<span>             <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plot-and-select-days_mat-parameters">4. Plot and select days_mat parameters<a class="anchor" aria-label="anchor" href="#plot-and-select-days_mat-parameters"></a>
</h2>
<p>After the running the model it is important to load the results and
visualize the crop yields, PHU fractions at harvest, biomass to assess
the performance of the model with the different <code>days_mat</code>
values. The <code>load_swat_run</code> function from the
<strong>SWATrunR</strong> package is used to load the most recent
simulation results from the <code>simulation</code> folder. The
<code><a href="../reference/plot_phu_yld_bms.html">plot_phu_yld_bms()</a></code> function is then used to visualize the
crop yields for each crop and <code>days_mat</code> value.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the most recent dmat simulation results</span></span>
<span><span class="va">dmat_sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">'./simulation/'</span>, pattern <span class="op">=</span> <span class="st">'[0-9]{12}_sim_dmat'</span><span class="op">)</span></span>
<span><span class="va">dmat_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'./simulation/'</span>, <span class="va">dmat_sims</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dmat_sims</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">ylds_phu_dmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/load_swat_run.html" class="external-link">load_swat_run</a></span><span class="op">(</span><span class="va">dmat_path</span>, add_date <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot PHU, crop yields and biomass over adjusted days to maturity values.</span></span>
<span><span class="fu"><a href="../reference/plot_phu_yld_bms.html">plot_phu_yld_bms</a></span><span class="op">(</span><span class="va">ylds_phu_dmat</span>, <span class="va">yield_obs</span><span class="op">)</span></span></code></pre></div>
<p><img src="figs/fig7.png" width="95%" style="display: block; margin: auto;"></p>
<p>From this figure you can select the <code>days_mat</code> values for
each crop that fall within PHU correct interval 1 - 1.2 and the best
match the observed yields. The selected values are saved with this code
snippet as <code>dmat_sel</code> and will be used in the next step.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set days to maturity values for all selected crops based on the figure above.</span></span>
<span><span class="va">dmat_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  plant_name                       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'corn'</span>, <span class="st">'cots'</span>, <span class="st">'pnut'</span><span class="op">)</span>,</span>
<span>  <span class="st">'days_mat.pdb | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">140</span>, <span class="fl">160</span>, <span class="fl">160</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check if user defined days to maturity values for all crops.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">crop_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">dmat_sel</span><span class="op">$</span><span class="va">plant_name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Update names of dmat_sel to be used as SWATrunR parameters</span></span>
<span><span class="va">dmat_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_plant_parameter.html">prepare_plant_parameter</a></span><span class="op">(</span><span class="va">dmat_sel</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="add-additional-parameters">5. Add additional parameters<a class="anchor" aria-label="anchor" href="#add-additional-parameters"></a>
</h2>
<p>In addition to <code>days_mat</code>, you can also adjust other
parameters such as leaf area index (<code>lai_pot</code>), harvest index
(<code>harv_idx</code>), base temperature for plant growth
(<code>tmp_base</code>), and biomass energy ratio (<code>bm_e</code>).
These parameters can be adjusted in a similar way as
<code>days_mat</code> by creating a parameter set with the
<code><a href="../reference/sample_lhs.html">sample_lhs()</a></code> function. When making these updates, it is
important to ensure that the resulting values remain realistic and
biologically meaningful—for example, avoiding negative values or ranges
that fall outside plausible agronomic limits.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_bnd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">'lai_pot.pdb | change = relchg'</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.3</span>, <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>                  <span class="st">'harv_idx.pdb | change = relchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.3</span>, <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>                  <span class="st">'tmp_base.pdb | change = abschg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span><span class="op">)</span>,</span>
<span>                  <span class="st">'bm_e.pdb | change = relchg'</span>     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.3</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## The number of samples can be adjusted based on the available computational resources.</span></span>
<span><span class="co">## Recommended number of samples is 50-100.</span></span>
<span><span class="va">par_crop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_lhs.html">sample_lhs</a></span><span class="op">(</span><span class="va">par_bnd</span>, <span class="va">n_combinations</span><span class="op">)</span></span>
<span><span class="co"># Add updated days to maturity values to parameter set</span></span>
<span><span class="va">par_crop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">par_crop</span>, <span class="va">dmat_sel</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-model-for-additional-parameter-set">6. Run model for additional parameter set<a class="anchor" aria-label="anchor" href="#run-model-for-additional-parameter-set"></a>
</h2>
<p>With all parameters defined, you can now run the SWAT+ model again
using the <code>run_swatplus</code> function. This will execute the
model simulations for each combination of parameters in
<code>par_bnd</code>, and the results will be stored in the
<code>./simulation</code> folder.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the SWAT+ model with the additional parameter set</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/run_swatplus.html" class="external-link">run_swatplus</a></span><span class="op">(</span>project_path <span class="op">=</span> <span class="va">model_path</span>,</span>
<span>             output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>yld <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/define_output.html" class="external-link">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'mgtout'</span>,</span>
<span>                                               variable <span class="op">=</span> <span class="st">'yld'</span>,</span>
<span>                                               label <span class="op">=</span> <span class="va">crop_names</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             parameter <span class="op">=</span> <span class="va">par_crop</span>,</span>
<span>             start_date       <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Change if necessary.</span></span>
<span>             end_date         <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Change if necessary.</span></span>
<span>             years_skip       <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Change if necessary.</span></span>
<span>             n_thread         <span class="op">=</span> <span class="va">n_cores</span>,</span>
<span>             save_path        <span class="op">=</span> <span class="st">'./simulation'</span>,</span>
<span>             save_file        <span class="op">=</span> <span class="fu"><a href="../reference/add_timestamp.html">add_timestamp</a></span><span class="op">(</span><span class="st">'sim_yld'</span><span class="op">)</span>,</span>
<span>             return_output    <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>             time_out         <span class="op">=</span> <span class="fl">3600</span> <span class="co"># seconds, change if run-time differs</span></span>
<span>             <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plot-and-select-values-for-parameters">7. Plot and select values for parameters<a class="anchor" aria-label="anchor" href="#plot-and-select-values-for-parameters"></a>
</h2>
<p>After running the model with the additional parameters, you can load
and visualize the results to assess the impact of the changes on crop
yields. The <code><a href="../reference/plot_dotty_yields.html">plot_dotty_yields()</a></code> function is used to plot
the crop yields for each combination of parameters, allowing you to
select the best-performing parameter set based on yield performance.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the most recent yield simulation results</span></span>
<span><span class="va">yld_sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">'./simulation/'</span>, pattern <span class="op">=</span> <span class="st">'[0-9]{12}_sim_yld'</span><span class="op">)</span></span>
<span><span class="va">yld_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'./simulation/'</span>, <span class="va">yld_sims</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">yld_sims</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">yld_sim</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/load_swat_run.html" class="external-link">load_swat_run</a></span><span class="op">(</span><span class="va">yld_path</span>, add_date <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># Remove days to maturity parameter columns before plotting.</span></span>
<span><span class="va">yld_sim</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">values</span> <span class="op">&lt;-</span> <span class="va">yld_sim</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">values</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## Plot dotty figures for the selected crops</span></span>
<span><span class="fu"><a href="../reference/plot_dotty_yields.html">plot_dotty_yields</a></span><span class="op">(</span><span class="va">yld_sim</span>, <span class="va">yield_obs</span><span class="op">)</span></span></code></pre></div>
<p><img src="figs/fig8.png" width="95%" style="display: block; margin: auto;"></p>
<p>Based on this figure user can select the best performing parameter
set for each crop. The selected values are saved in
<code>crop_par_sel</code> and will be used in the final run.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fix the parameter changes you want to apply to the crops</span></span>
<span><span class="va">crop_par_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  plant_name                       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"corn"</span>, <span class="st">"cots"</span>, <span class="st">"pnut"</span><span class="op">)</span>,</span>
<span>  <span class="st">'bm_e.pdb | change = relchg'</span>     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>  <span class="op">-</span><span class="fl">0.2</span>,   <span class="op">-</span><span class="fl">0.3</span>,   <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>  <span class="st">'harv_idx.pdb | change = relchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>  <span class="op">-</span><span class="fl">0.15</span>,  <span class="op">-</span><span class="fl">0.3</span>,   <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>  <span class="st">'lai_pot.pdb | change = relchg'</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>  <span class="op">-</span><span class="fl">0.2</span>,   <span class="op">-</span><span class="fl">0.3</span>,   <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>  <span class="st">'tmp_base.pdb | change = abschg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>   <span class="fl">1.5</span>,    <span class="fl">1.5</span>,  <span class="op">-</span><span class="fl">1.0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check if user defined days to maturity values for all crops.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">crop_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">crop_par_sel</span><span class="op">$</span><span class="va">plant_name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Restructure the set parameter changes to SWATrunR</span></span>
<span><span class="va">crop_par_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_plant_parameter.html">prepare_plant_parameter</a></span><span class="op">(</span><span class="va">crop_par_sel</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-final-simulation-evaluate-results">8. Run final simulation, evaluate results<a class="anchor" aria-label="anchor" href="#run-final-simulation-evaluate-results"></a>
</h2>
<p>In the final step, you can run the SWAT+ model with the selected
parameters using the <code>run_swatplus</code> function. This will
execute the model simulations for the final parameter set, and the
results will be stored in the <code>./simulation</code> folder.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the simulations</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/run_swatplus.html" class="external-link">run_swatplus</a></span><span class="op">(</span>project_path <span class="op">=</span> <span class="va">model_path</span>,</span>
<span>             output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>yld <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/define_output.html" class="external-link">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'mgtout'</span>,</span>
<span>                                               variable <span class="op">=</span> <span class="st">'yld'</span>,</span>
<span>                                               label <span class="op">=</span> <span class="va">crop_names</span><span class="op">)</span>,</span>
<span>                           bms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/define_output.html" class="external-link">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'mgtout'</span>,</span>
<span>                                               variable <span class="op">=</span> <span class="st">'bioms'</span>,</span>
<span>                                               label <span class="op">=</span> <span class="va">crop_names</span><span class="op">)</span>,</span>
<span>                           phu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/define_output.html" class="external-link">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'mgtout'</span>,</span>
<span>                                               variable <span class="op">=</span> <span class="st">'phu'</span>,</span>
<span>                                               label <span class="op">=</span> <span class="va">crop_names</span><span class="op">)</span></span>
<span>             <span class="op">)</span>,</span>
<span>             parameter        <span class="op">=</span> <span class="va">par_final</span>,</span>
<span>             start_date       <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Change if necessary.</span></span>
<span>             end_date         <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Change if necessary.</span></span>
<span>             years_skip       <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># Change if necessary.</span></span>
<span>             n_thread         <span class="op">=</span> <span class="va">n_cores</span>,</span>
<span>             save_path        <span class="op">=</span> <span class="st">'./simulation'</span>,</span>
<span>             save_file        <span class="op">=</span> <span class="fu"><a href="../reference/add_timestamp.html">add_timestamp</a></span><span class="op">(</span><span class="st">'sim_check01'</span><span class="op">)</span>,</span>
<span>             return_output    <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>             time_out         <span class="op">=</span> <span class="fl">3600</span>, <span class="co"># seconds, change if run-time differs</span></span>
<span>             keep_folder      <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The final simulation results can be evaluated using the
<code><a href="../reference/plot_phu_yld_bms.html">plot_phu_yld_bms()</a></code> function. This plot will help assess
whether the changes made to the four parameters have significantly
affected crop yield, biomass, or PHU values. Ideally, these outputs
should remain consistent (in ranges for PHU and yields), as the main
issues related to days-to-maturity were already addressed in the first
part of the script.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the most recent check simulation results</span></span>
<span><span class="va">check_sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">'./simulation/'</span>, pattern <span class="op">=</span> <span class="st">'[0-9]{12}_sim_check01'</span><span class="op">)</span></span>
<span><span class="va">check_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'./simulation/'</span>, <span class="va">check_sims</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">check_sims</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">check_sim</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/load_swat_run.html" class="external-link">load_swat_run</a></span><span class="op">(</span><span class="va">check_path</span>, add_date <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot PHU, crop yields and biomass for final simulation run.</span></span>
<span><span class="fu"><a href="../reference/plot_phu_yld_bms.html">plot_phu_yld_bms</a></span><span class="op">(</span><span class="va">check_sim</span>, <span class="va">yield_obs</span>, <span class="fl">0.3</span><span class="op">)</span></span></code></pre></div>
<p><img src="figs/fig9.png" width="95%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="write-plants-plt">9. Write ‘plants.plt’<a class="anchor" aria-label="anchor" href="#write-plants-plt"></a>
</h2>
<p>If the final simulation results look acceptable, you can save the
adjusted parameter table to the project folder by setting
<code>overwrite = TRUE</code> in the command below. This will replace
the original <code>plants.plt</code> file. A backup of the original file
is available at <code>./backup/plants.plt</code> in case you need to
restore it.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">model_path</span>, <span class="st">'/.model_run/thread_1/plants.plt'</span><span class="op">)</span>, <span class="va">model_path</span>,</span>
<span>          overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">model_path</span>, <span class="st">'/.model_run'</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Svajunas Plunge, Christoph Schuerz, Michael Strauch, Mikołaj Piniewski.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
