<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SWATtunR">
<title>Run calibration • SWATtunR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run calibration">
<meta property="og:description" content="SWATtunR">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SWATtunR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Soft calibration</h6>
    <a class="dropdown-item" href="../articles/sc-crops.html">Crop Yields</a>
    <a class="dropdown-item" href="../articles/sc-wy.html">Water Yield</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Hard calibration</h6>
    <a class="dropdown-item" href="../articles/hc.html">Run calibration</a>
    <a class="dropdown-item" href="../articles/hc-plot.html">Plot results</a>
    <a class="dropdown-item" href="../articles/hc-plus.html">Extend calibration</a>
    <a class="dropdown-item" href="../articles/val.html">Validation</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Quality Assurance</h6>
    <a class="dropdown-item" href="../articles/qa.html">Preparation</a>
    <a class="dropdown-item" href="../articles/qa-st1.html">Step 1: Input</a>
    <a class="dropdown-item" href="../articles/qa-st2.html">Step 2: Management</a>
    <a class="dropdown-item" href="../articles/qa-st3.html">Step 3: Growth</a>
    <a class="dropdown-item" href="../articles/qa-st4.html">Step 4: Stress</a>
    <a class="dropdown-item" href="../articles/qa-st5.html">Step 5: Other</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/biopsichas/SWATtunR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Run calibration</h1>
            <h3 data-toc-skip class="subtitle">Hard calibration workflow
for SWAT+ models</h3>
            
      
      <small class="dont-index">Source: <a href="https://github.com/biopsichas/SWATtunR/blob/HEAD/vignettes/hc.Rmd" class="external-link"><code>vignettes/hc.Rmd</code></a></small>
      <div class="d-none name"><code>hc.Rmd</code></div>
    </div>

    
    
<p>The calibration of the SWAT+ model is crucial for ensuring its
accuracy and reliability in simulating hydrological processes and
predicting the impacts of land management practices on water resources.
Calibration involves adjusting the model’s parameters to match observed
data, such as streamflow, sediment yield, and nutrient loads, thereby
improving its representation of the real-world watershed conditions.
This process enhances the model’s predictive capability, making it a
more effective tool for water resource management, policy-making,
planning and in the context of assessing the effects of climate change,
land use alterations, and conservation practices. This page provides
steps and tools to perform a hard calibration of SWAT+ models using
scripted workflows.</p>
<div class="section level2">
<h2 id="hc_step1">1. Loading required packages<a class="anchor" aria-label="anchor" href="#hc_step1"></a>
</h2>
<p>The first step in the hard calibration workflow is to load the
necessary R packages. These packages provide functions and tools for
data manipulation, visualization, and model calibration. The following
code chunk loads the required packages for the hard calibration
workflow.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/biopsichas/SWATtunR" class="external-link">SWATtunR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chrisschuerz/SWATrunR" class="external-link">SWATrunR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hc_step2">2. Defining settings<a class="anchor" aria-label="anchor" href="#hc_step2"></a>
</h2>
<p>The next step is to define the settings for the hard calibration
workflow. This includes specifying the SWAT+ model path, input files,
calibration parameters, observed data, and other relevant information.
The following code chunk sets up the necessary settings for the hard
calibration workflow.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Path to the SWAT+ model</span></span>
<span><span class="va">model_path</span> <span class="op">&lt;-</span> <span class="st">'../test/my_dearest_model'</span></span>
<span></span>
<span><span class="co"># Path to the crop data file</span></span>
<span><span class="va">qobs_path</span> <span class="op">&lt;-</span> <span class="st">'../inst/extdata/q_cha.csv'</span></span>
<span></span>
<span><span class="co"># Define the path to the observed WQ data</span></span>
<span><span class="va">wqobs_path</span> <span class="op">&lt;-</span> <span class="st">'../inst/extdata/no3.csv'</span></span>
<span></span>
<span><span class="co"># You can define the path to the other observed data, like groundwater depth data, etc.</span></span>
<span><span class="va">gwobs_path</span> <span class="op">&lt;-</span> <span class="st">'../inst/extdata/gw.csv'</span></span>
<span></span>
<span><span class="co"># Set the path to save results of the soft calibration</span></span>
<span><span class="va">sc_res</span> <span class="op">&lt;-</span> <span class="st">'../test/simulations'</span></span>
<span></span>
<span><span class="co"># Set the number of cores available for calculations.  </span></span>
<span><span class="co"># Number of cores for 12 runs use 3, 4, 6, or 12 cores (if available)</span></span>
<span><span class="va">cores</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span></span>
<span><span class="co"># Channel IDs where gauges are located at the channel outlets.</span></span>
<span><span class="va">cha_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">67</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the simulation save file names to be used in SWATrunR</span></span>
<span><span class="va">save_file_name</span> <span class="op">&lt;-</span> <span class="st">"sim1"</span></span>
<span></span>
<span><span class="co"># Number parameter combinations to run</span></span>
<span><span class="va">n_comb</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># Fraction of the best parameter combinations to be used for the final </span></span>
<span><span class="co"># WQ calibration</span></span>
<span><span class="va">n_best</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co"># example n_best &lt;- .02 # 2% of the best parameter combinations, </span></span>
<span><span class="co"># if NULL, n_best = 20/n_comb</span></span>
<span></span>
<span><span class="co"># Number of combination drawn for the nutrient parameters (this number </span></span>
<span><span class="co"># is multiplied by the number of selected parameter combinations for the flow.</span></span>
<span><span class="co"># For example n_comb = 1000, n_best .1, means 100 best runs selected, multiplied</span></span>
<span><span class="co"># with n_nutr = 100 results in 10,000 model runs for the nutrient calibration.</span></span>
<span><span class="co"># If null, 1000/(n_comb*n_best) formula applied resulting in 1000 runs)</span></span>
<span><span class="va">n_nutr</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co"># Number of cores to be used for the parallelization of the model runs</span></span>
<span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co">## If NULL, all available physical cores - 2 will be used</span></span>
<span></span>
<span><span class="co"># Define time period to be used in model runs. Please note this period should</span></span>
<span><span class="co"># match your management data period, if it was prepared with SWATfarmR. You can</span></span>
<span><span class="co"># safely modify 'start_date_print' and 'end_date' to define the period for which</span></span>
<span><span class="co"># you want to print the model output. However, please take great care, if you </span></span>
<span><span class="co"># modify 'start_date' as you might need to update your management files too. </span></span>
<span></span>
<span><span class="co"># Start date for model runs (if NULL, the start date of the model setup files </span></span>
<span><span class="co"># will be used!!!)</span></span>
<span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co"># start_date &lt;- '2000-01-01'</span></span>
<span><span class="co"># End date for model runs (if NULL, the end date of observation data will be used).</span></span>
<span><span class="va">end_date</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co"># end_date &lt;- '2010-12-31'</span></span>
<span><span class="co"># Start printing model output (if NULL, the start date of observation data will used).</span></span>
<span><span class="va">start_date_print</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co"># start_date_print &lt;-'2003-01-01'</span></span>
<span></span>
<span><span class="co"># Define calibration and validation periods. Please note that the validation </span></span>
<span><span class="co"># should take around 1/3 and calibration 2/3 of the total period. Also the </span></span>
<span><span class="co"># workflow will run all simulations for the whole period (defined above), </span></span>
<span><span class="co"># these periods are only used for the performance calculation and plotting.</span></span>
<span></span>
<span><span class="co"># Q calibration period</span></span>
<span><span class="va">q_cal_period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'2007-01-01'</span>, <span class="st">'2010-01-01'</span><span class="op">)</span></span>
<span><span class="co"># Calibration end date</span></span>
<span><span class="va">q_val_period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'2011-01-01'</span>, <span class="st">'2022-12-31'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># WQ calibration period</span></span>
<span><span class="va">wq_cal_period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'2012-01-01'</span>, <span class="st">'2017-12-31'</span><span class="op">)</span></span>
<span><span class="co"># Calibration end date</span></span>
<span><span class="va">wq_val_period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'2018-12-31'</span>, <span class="st">'2022-12-31'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hc_step3">3. Preparing parameters sets for the flow (and water quality)
calibration<a class="anchor" aria-label="anchor" href="#hc_step3"></a>
</h2>
<p>The suggested list and ranges of SWAT+ parameters for hydrology
calibration are divided into groups based on the primary processes they
affect. Some groups are considered optional. These parameters help
fine-tune the model to achieve accurate hydrological simulations,
ensuring that various aspects of the hydrological cycle are properly
represented.</p>
<p>It is important to note that calibration and validation of all
hydrology and water quality/load related parameters could be done in one
step. For this, you need to define the nutrient parameters together with
hydrology. Please refer to <a href="#hc_plus_step3">step 3</a> on the <a href="../articles/hc-plus.html">Extend calibration</a> page for an
example of how to define sediment, nitrogen, and phosphorus parameters.
The example here presents only hydrology parameters.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_bound</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  <span class="co"># Snow (optional - use if average snow fall to precipitation ratio is higher </span></span>
<span>  <span class="co"># than 5%)</span></span>
<span>  <span class="st">'snomelt_tmp.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span><span class="op">)</span>,</span>
<span>  <span class="st">'snofall_tmp.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span><span class="op">)</span>,</span>
<span>  <span class="co"># ET (note: it is suggested that a narrow range for esco selected in soft </span></span>
<span>  <span class="co"># calibration of water balance is used instead of the wide (0,1) range)</span></span>
<span>  <span class="st">'esco.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>  <span class="st">'epco.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="st">'awc.sol | change = relchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.25</span><span class="op">)</span>,</span>
<span>  <span class="st">'canmx.hru | change = relchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  <span class="co">#surface runoff</span></span>
<span>  <span class="st">'cn2.hru | change = relchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.15</span>, <span class="fl">0.15</span><span class="op">)</span>,</span>
<span>  <span class="st">'cn3_swf.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="st">'ovn.hru | change  = relchg '</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.25</span><span class="op">)</span>,</span>
<span>  <span class="st">'surlag.bsn | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  <span class="co"># lateral flow (optional - use if lateral flow constitutes at least 5% of total </span></span>
<span>  <span class="co"># water yield)</span></span>
<span>  <span class="co">#'lat_time.hru | change = relchg' = c(-0,15, 0.15),</span></span>
<span>  <span class="st">'lat_len.hru | change = abschg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">30</span>, <span class="fl">30</span><span class="op">)</span>,</span>
<span>  <span class="st">'latq_co.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="st">'bd.sol | change = relchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.25</span><span class="op">)</span>,</span>
<span>  <span class="st">'k.sol | change = relchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="co"># tile flow (optional - use if tile flow constitutes at least 5% of total water</span></span>
<span>  <span class="co"># yield; note: tile_lag and tile_dtime should be active only if tile_drain is </span></span>
<span>  <span class="co"># set to 0 in codes.bsn file))</span></span>
<span>  <span class="co">#'tile_dep.hru | change = relchg' = c(-0.1, 0.2),</span></span>
<span>  <span class="co">#'tile_lag.hru | change = absval' = c(48, 100),</span></span>
<span>  <span class="co">#'tile_dtime.hru | change = absval' = c(48, 100),</span></span>
<span>  <span class="co">#percolation/aquifer</span></span>
<span>  <span class="st">'perco.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="st">'flo_min.aqu | change = abschg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="st">'revap_co.aqu | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>  <span class="st">'revap_min.aqu | change = abschg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="st">'alpha.aqu | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.001</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  <span class="co"># 'sp_yld.aqu | change = absval' = c(0.001, 0.05),</span></span>
<span>  <span class="st">'bf_max.aqu | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="co">#channel routing</span></span>
<span>  <span class="st">'chn.rte | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Draw a first parameter set of parameter combinations </span></span>
<span><span class="va">par_flow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_lhs.html">sample_lhs</a></span><span class="op">(</span><span class="va">par_bound</span>, <span class="va">n_comb</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hc_step3a">3a. (Optional) Calibration of parameters for HRU groups<a class="anchor" aria-label="anchor" href="#hc_step3a"></a>
</h2>
<p>For some parameters it might be important to differentiate
calibration values based on some characteristic of areas. For instance
the parameters <a href="https://swatplus.gitbook.io/io-docs/introduction/hydrology/hydrology.hyd/cn3_swf" class="external-link"><code>cn3_swf</code></a>
(soil water adjustment factor for CN3) and <a href="https://swatplus.gitbook.io/io-docs/introduction/hydrology/hydrology.hyd/cn_plntet" class="external-link"><code>latq_co</code></a>
(lateral flow coefficient) are initialized based on the runoff potential
of a Hydrologic Response Unit (HRU), while the parameter <a href="https://swatplus.gitbook.io/io-docs/introduction/hydrology/hydrology.hyd/perco" class="external-link"><code>perco</code></a>
(percolation coefficient) is initialized based on its leaching
potential. <code>perco</code>, <code>cn3_swf</code>, and
<code>latq_co</code> have normalized range <em>0</em>-<em>1</em>, which
sampled as single value, but better approach is considering their
different initial values. Therefore, the parameter sampling could be
conducted as follows:</p>
<ul>
<li>From <a href="https://swatplus.gitbook.io/io-docs/introduction/hydrology/hydrology.hyd" class="external-link"><code>'hydrology.hyd'</code></a>,
HRU IDs with low, moderate, and high leaching and runoff potentials are
drawn.</li>
<li>These IDs are compiled into text strings required for parameter
definition via the parameter names.</li>
<li>Parameter boundaries or the different low, moderate, and high
potentials are defined.</li>
<li>The normalized parameter ranges are translated into the defined
boundaries.</li>
</ul>
<p>This is a very reduced set for testing purposes and does not include
all parameters that could be used in model setups.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read the hydrology.hyd file to identify the HRU IDs with the different </span></span>
<span><span class="co"># runoff and leaching potentials.</span></span>
<span><span class="va">hyd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_tbl.html">read_tbl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">model_path</span>, <span class="st">'/hydrology.hyd'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate the ID text strings to be included in the parameter names so that </span></span>
<span><span class="co"># parameter values for HRUs can be addressed separately.</span></span>
<span><span class="va">id_lch_pot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/id_text_strings.html">id_text_strings</a></span><span class="op">(</span><span class="st">'perco'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>low <span class="op">=</span> <span class="fl">0.01</span>, mod <span class="op">=</span> <span class="fl">0.50</span>, high <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>, <span class="va">hyd</span><span class="op">)</span></span>
<span><span class="va">id_run_pot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/id_text_strings.html">id_text_strings</a></span><span class="op">(</span><span class="st">'cn3_swf'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>low <span class="op">=</span> <span class="fl">0.95</span>, mod <span class="op">=</span> <span class="fl">0.30</span>, high <span class="op">=</span> <span class="fl">0.00</span><span class="op">)</span>, <span class="va">hyd</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define parameter boundaries in which the parameter values should vary for </span></span>
<span><span class="co"># the different leaching and runoff potentials.</span></span>
<span><span class="va">perco_bound</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.30</span><span class="op">)</span>, mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.30</span>, <span class="fl">0.60</span><span class="op">)</span>, high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.90</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cn3_bound</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.50</span>, <span class="fl">0.95</span><span class="op">)</span>, mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.45</span><span class="op">)</span>, high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">0.30</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">latq_bound</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.30</span><span class="op">)</span>, mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.10</span>, <span class="fl">0.40</span><span class="op">)</span>, high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.90</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Translate the normalized parameter ranges into the defined boundary ranges.</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'low'</span>, <span class="st">'mod'</span>, <span class="st">'high'</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">id_lch_pot</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">par_flow</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'perco_'</span>, </span>
<span>                     <span class="va">i</span>, <span class="st">'::perco.hru | change = absval | unit = c('</span>, </span>
<span>                     <span class="va">id_lch_pot</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">')'</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>  </span>
<span>      <span class="va">par_flow</span><span class="op">[[</span><span class="st">'perco.hru | change = absval'</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="va">perco_bound</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">perco_bound</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">perco_bound</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">id_run_pot</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">par_flow</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'cn3_'</span>, <span class="va">i</span>, <span class="st">'::cn3_swf.hru | change = absval | unit = c('</span>, </span>
<span>                     <span class="va">id_run_pot</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">')'</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> </span>
<span>      <span class="va">par_flow</span><span class="op">[[</span><span class="st">'cn3_swf.hru | change = absval'</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="va">cn3_bound</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">cn3_bound</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">cn3_bound</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">par_flow</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'latq_'</span>, <span class="va">i</span>, <span class="st">'::latq_co.hru | change = absval | unit = c('</span>, </span>
<span>                     <span class="va">id_run_pot</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">')'</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">par_flow</span><span class="op">[[</span><span class="st">'latq_co.hru | change = absval'</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> </span>
<span>      <span class="op">(</span><span class="va">latq_bound</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">latq_bound</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">latq_bound</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Remove the initial normalized parameters.</span></span>
<span><span class="va">par_flow</span> <span class="op">&lt;-</span> <span class="va">par_flow</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'perco.hru'</span>, <span class="st">'cn3_swf.hru'</span>, <span class="st">'latq_co.hru'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Or this method in case you get an error (e.g., due to hru number &gt;10k)</span></span>
<span><span class="co"># par_flow &lt;- par_flow[, !grepl("^perco.hru|^cn3_swf.hru|^latq_co.hru", names(par_flow))]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hc_step4">4. Running simulations<a class="anchor" aria-label="anchor" href="#hc_step4"></a>
</h2>
<p>Prepared parameter sets are used to run simulations. The SWAT+ model
is executed for the defined period, and the daily hydrographs (in this
example) are stored for the channel IDs. The simulation is run in
parallel, and the number of cores used can be defined. The simulation
results are stored in the defined output folder. Observed discharge data
are read to obtain the period needed for the runs.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read the observed discharge data to obtain period needed for the runs.</span></span>
<span><span class="va">obs_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">qobs_path</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">model_path</span>, <span class="st">"/"</span>, <span class="va">save_file_name</span>, <span class="st">'_q'</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Remove </span></span>
<span><span class="co"># the previous saved runs if they exist.</span></span>
<span></span>
<span><span class="co"># Simulate daily discharge for the channel IDs.</span></span>
<span><span class="va">sim_flow_full_bck</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/run_swatplus.html" class="external-link">run_swatplus</a></span><span class="op">(</span>project_path <span class="op">=</span> <span class="va">model_path</span>,</span>
<span>                         output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                           flo_day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SWATrunR/man/define_output.html" class="external-link">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'channel_sd_day'</span>,</span>
<span>                                                   variable <span class="op">=</span> <span class="st">'flo_out'</span>,</span>
<span>                                                   unit <span class="op">=</span> <span class="va">cha_ids</span><span class="op">)</span></span>
<span>                         <span class="op">)</span>,</span>
<span>                         parameter <span class="op">=</span> <span class="va">par_flow</span>,</span>
<span>                         start_date <span class="op">=</span> <span class="va">start_date</span>,</span>
<span>                         end_date <span class="op">=</span> <span class="va">end_date</span>,</span>
<span>                         start_date_print <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/as_date.html" class="external-link">as_date</a></span><span class="op">(</span></span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">start_date_print</span><span class="op">)</span><span class="op">==</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">obs_full</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>, </span>
<span>                                  <span class="va">start_date_print</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         <span class="co"># Get the number of cores to be used for parallel processing.</span></span>
<span>                         n_thread <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cores</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span>, </span>
<span>                                           <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span>logical <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span>, <span class="va">cores</span><span class="op">)</span>,</span>
<span>                         save_file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">save_file_name</span>, <span class="st">'_q'</span><span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># If you have to remove the runs that did not finish, use the following code.</span></span>
<span><span class="va">sim_flow_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/remove_unsuccesful_runs.html">remove_unsuccesful_runs</a></span><span class="op">(</span><span class="va">sim_flow_full_bck</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># If you have to load the runs from the saved runs in the data bases, use the</span></span>
<span><span class="co"># following code.</span></span>
<span><span class="co"># sim_flow &lt;- SWATrunR::load_swat_run(paste0(model_path, '/',  paste0(save_file_name, '_q')))</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hc_step5">5. (Optional) Getting concentrations<a class="anchor" aria-label="anchor" href="#hc_step5"></a>
</h2>
<p>If you need to calculate and use concentrations together with flow
values in the next steps, use the <a href="../reference/get_conc.html">get_conc</a> function. It has two
optional arguments: <code>not_conc</code> and <code>sediment</code>. The
<code>not_conc</code> argument is a regular expression that defines the
variables which should not be converted to concentrations. By default,
it is set to “^flo_day|^gwd”. The <code>sediment</code> argument is a
regular expression that defines the variables which should be identified
as sediment variables. The default for this argument is “^sed”.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the concentrations for the daily discharge.</span></span>
<span><span class="va">sim_flow_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_conc.html">get_conc</a></span><span class="op">(</span><span class="va">sim_flow_full</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hc_step6">6. Readjusting observation and simulation periods<a class="anchor" aria-label="anchor" href="#hc_step6"></a>
</h2>
<p>To align the dates of the simulated and observed data for the
calibration period (or validation), the <a href="../reference/fix_dates.html">fix_dates</a> function could be used.
This function adjusts the dates to ensure that the simulated data
matches the observed data and can also trim the dataset to a specified
time range.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Align the dates of the simulated and observed data for the discharge calibration period.</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fix_dates.html">fix_dates</a></span><span class="op">(</span><span class="va">sim_flow_full</span>, <span class="va">obs_full</span>, trim_start <span class="op">=</span> <span class="va">q_cal_period</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                 trim_end <span class="op">=</span> <span class="va">q_cal_period</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">sim_flow</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">$</span><span class="va">sim</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">$</span><span class="va">obs</span></span>
<span><span class="co">## Example of usage for trimming the data to a specific period.</span></span>
<span><span class="co"># tmp &lt;- fix_dates(runr_obj = sim_flow, obs_obj = obs, </span></span>
<span><span class="co"># trim_start = "2010-01-01", trim_end = "2015-01-01")</span></span>
<span></span>
<span><span class="co"># In case you want to use water quality data, read it here before applying the following code.</span></span>
<span><span class="co"># obs2 &lt;- read_csv(wqobs_path) </span></span>
<span><span class="co"># tmp &lt;- fix_dates(sim_flow_full, obs2, trim_start = wq_cal_period[1], trim_end = wq_cal_period[2])</span></span>
<span><span class="co"># obs2 &lt;- tmp$obs</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hc_step7">7. Calculating performance metrics<a class="anchor" aria-label="anchor" href="#hc_step7"></a>
</h2>
<p>To calculate the performance metrics for the simulated discharge, the
<code>sim</code> object containing the simulated discharge data and the
<code>obs</code> object with the observed discharge data are required.
The parameter <code>par_name</code> specifies the variable for which the
performance metrics should be calculated; if not provided, it defaults
to the first variable in the simulation list. For cases with multiple
variables, specifying <code>par_name</code> is necessary. The
<code>perf_metrics</code> parameter allows the selection of performance
metrics for the calculation, which will influence the final ranking used
in the selection of parameter sets in <a href="#hc_step7">step 7</a>. If
<code>perf_metrics</code> is not provided, all available metrics will be
used. The <code>period</code> parameter defines the time interval for
calculating performance metrics, such as “week”, “month,” or “year”. The
<code>fn_summarize</code> parameter specifies the function to summarize
data over the defined period, such as “mean”, “median”, “max”, “min” or
“sum”.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate the performance metrics for the daily discharge.</span></span>
<span></span>
<span><span class="va">obj_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_performance.html">calculate_performance</a></span><span class="op">(</span><span class="va">sim_flow</span>, <span class="va">obs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example of usage: </span></span>
<span><span class="co"># obj_tbl &lt;- calculate_performance(sim = sim_flow, obs, "flo_day", c("kge", "nse"), </span></span>
<span><span class="co"># "month", "sum")</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hc_step7a">7a. Calculating performance metrics for multiple variables<a class="anchor" aria-label="anchor" href="#hc_step7a"></a>
</h2>
<p>The performance metrics can also be applied to multiple variables
within the simulation list. In this scenario, the performance metrics
will be calculated separately for each variable, and subsequently, the
mean of the performance ranks will be determined. Additionally, weights
can be assigned to each variable in this process, allowing for a more
nuanced evaluation that takes into account the relative importance of
each variable.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example of usage:</span></span>
<span><span class="va">var_to_use</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"flo_day_52"</span>,  <span class="st">"no3_day_52_conc"</span>, <span class="st">"gwd"</span><span class="op">)</span></span>
<span><span class="va">var_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span><span class="op">)</span> <span class="co">## The sum of weights should be 1.</span></span>
<span><span class="va">periods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">q_cal_period</span>, <span class="va">wq_cal_period</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'2007-01-01'</span>, <span class="st">'2011-12-26'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read the another observed data</span></span>
<span><span class="co"># In case you want to use water quality data, read it here before applying the </span></span>
<span><span class="co"># following code.</span></span>
<span><span class="va">obs2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">wqobs_path</span><span class="op">)</span> </span>
<span><span class="va">obs3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">gwobs_path</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Calculate the performance metrics for each variable separately.</span></span>
<span><span class="va">obj_tbl_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_performance_2plus.html">calculate_performance_2plus</a></span><span class="op">(</span><span class="va">sim_flow_full</span>, <span class="va">var_to_use</span>, </span>
<span>                                         <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">obs</span>, <span class="va">obs2</span>, <span class="va">obs3</span><span class="op">)</span>, <span class="va">periods</span>, </span>
<span>                                         <span class="va">var_weights</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hc_step8">8. Selecting the best parameter sets<a class="anchor" aria-label="anchor" href="#hc_step8"></a>
</h2>
<p>To select the best-performing parameter sets for continuing next
iteration of calibration or going into water quality (WQ) calibration or
proceeding into validation, you can follow two methods. The first method
is based on the rank of performance metrics. Filter the parameter sets
to include only the best-performing ones. The number of best sets
(<code>n_best</code>) parameters in <a href="#hc_step2">step 2</a>
determines this. If <code>n_best = NULL</code> , then 20 the best sets
are selected, otherwise this numebr is calculated based on specified
ratio. The selected run IDs are obtained by arranging the parameter sets
by their total rank and selecting the top fraction.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_best</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">n_best</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">20</span><span class="op">/</span><span class="va">n_comb</span>, <span class="va">n_best</span><span class="op">)</span></span>
<span></span>
<span><span class="va">run_sel_ids</span> <span class="op">&lt;-</span> <span class="va">obj_tbl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">rank_tot</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html" class="external-link">top_frac</a></span><span class="op">(</span><span class="op">-</span><span class="va">n_best</span>, wt <span class="op">=</span> <span class="va">rank_tot</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">run_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="va">as.numeric</span></span></code></pre></div>
<p>The second method is based on the thresholds of performance metrics,
which should be defined by the user based on the <a href="../articles/hc-plot.html.html">plots</a>. For example, you can
select the parameter sets where the Nash-Sutcliffe efficiency (NSE) is
greater than 0.5, the Kling-Gupta efficiency (KGE) is greater than 0.5,
and the absolute percent bias (PBIAS) is less than 15. After selecting
the run IDs based on these criteria, you can examine the selected
parameter sets by printing the run IDs and extracting the corresponding
rows from the <code>obj_tbl</code> data frame.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_sel_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu">str_remove</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">obj_tbl</span><span class="op">$</span><span class="va">nse</span> <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="op">&amp;</span> </span>
<span>                              <span class="va">obj_tbl</span><span class="op">$</span><span class="va">kge</span> <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="op">&amp;</span> </span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">obj_tbl</span><span class="op">$</span><span class="va">pbias</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span>, <span class="st">'run_'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You can examine the selected parameter sets by running the following
code.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Selected run ids are: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">run_sel_ids</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">obj_tbl_cal</span><span class="op">&lt;-</span> <span class="va">obj_tbl</span><span class="op">[</span><span class="va">run_sel_ids</span>,<span class="op">]</span></span></code></pre></div>
<p>After this proceed to <a href="../articles/hc-plot.html">Plot
results</a> page for guidance of the visualization of the results. Also
you can proceed to <a href="../articles/hc-plus.html">Extend
calibration</a> page for guidance on how to add additional parameters or
build another iteration to the SWAT+ model calibration process.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Svajunas Plunge, Christoph Schuerz, Michel Strauch, Mikołaj Piniewski.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
